<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Random Video Chat</title>
<style>
body{margin:0;background:#020617;color:#fff;font-family:Arial;display:flex;justify-content:center;align-items:center;height:100vh}
.app{width:380px;background:#020617;border-radius:14px;padding:15px;box-shadow:0 0 30px #000}
h3{text-align:center;margin:5px 0}
.id{background:#000;padding:8px;border-radius:6px;font-size:13px;text-align:center}
input,button{width:100%;padding:10px;margin-top:8px;border-radius:8px;border:none}
button{background:#2563eb;color:white;font-weight:bold}
.videos{display:flex;gap:8px;margin-top:10px}
video{width:50%;height:140px;background:black;border-radius:10px}
@media(max-width:600px){.app{width:95%}.videos{flex-direction:column}video{width:100%;height:220px}}
</style>
</head>
<body>
<div class="app">
<h3>Your ID</h3>
<div class="id" id="myId"></div>

<input id="callId" placeholder="Search / Call by ID">
<button onclick="callUser()">Call ID</button>
<button onclick="randomMatch()">ðŸŽ² Random Match</button>

<div class="videos">
<video id="localVideo" autoplay muted playsinline></video>
<video id="remoteVideo" autoplay playsinline></video>
</div>
</div>

<script>
const chars='ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
function shortId(){let s='';for(let i=0;i<6;i++)s+=chars[Math.floor(Math.random()*chars.length)];return s;}
let myId=localStorage.getItem('p2p-id');
if(!myId){myId=shortId();localStorage.setItem('p2p-id',myId);}
document.getElementById('myId').textContent=myId;

const socket=new WebSocket('ws://localhost:3000');
let pc,stream;
const ice={iceServers:[{urls:'stun:stun.l.google.com:19302'}]};

navigator.mediaDevices.getUserMedia({video:true,audio:true})
.then(s=>{stream=s;localVideo.srcObject=s});

socket.onopen=()=>socket.send(JSON.stringify({type:'register',id:myId}));
socket.onmessage=async e=>{
 const d=JSON.parse(e.data);
 if(d.type==='offer') answer(d.offer,d.from);
 if(d.type==='answer') pc.setRemoteDescription(d.answer);
 if(d.type==='candidate') pc.addIceCandidate(d.candidate);
 if(d.type==='random-found') callPeer(d.id);
};

function createPeer(to){
 pc=new RTCPeerConnection(ice);
 stream.getTracks().forEach(t=>pc.addTrack(t,stream));
 pc.ontrack=e=>remoteVideo.srcObject=e.streams[0];
 pc.onicecandidate=e=>e.candidate&&socket.send(JSON.stringify({type:'candidate',from:myId,to,candidate:e.candidate}));
}

async function callPeer(id){
 createPeer(id);
 const o=await pc.createOffer();
 await pc.setLocalDescription(o);
 socket.send(JSON.stringify({type:'offer',from:myId,to:id,offer:o}));
}
function callUser(){callPeer(callId.value)}
function randomMatch(){socket.send(JSON.stringify({type:'random',id:myId}))}

async function answer(offer,from){
 createPeer(from);
 await pc.setRemoteDescription(offer);
 const a=await pc.createAnswer();
 await pc.setLocalDescription(a);
 socket.send(JSON.stringify({type:'answer',from:myId,to:from,answer:a}));
}
</script>
</body>
</html>
